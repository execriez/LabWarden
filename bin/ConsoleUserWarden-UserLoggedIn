#!/bin/bash
#
# Short:    Do something when a user logs in
# Author:   Mark J Swift
# Version:  2.0.6
# Modified: 27-May-2017
#
# Called by ConsoleUserWarden as follows:    
#   ConsoleUserWarden-UserLoggedIn <ActiveConsoleUser>
#
# Executes the following Triggers
#   Sys-ConsoleUserLoggedIn "root" "<user>" (as root)
#   Usr-ConsoleUserLoggedIn                 (as <user>)

# ---

# Check we have the correct number of parameters
if [ $# -lt 1 ]
then
  exit 0
fi

# -- passes the user logging in as first parameter --

# Get user name
GLB_sv_ThisUserName="${1}"

# ---

# If necessary, create the local user folder
if ! test -e "/Users/${GLB_sv_ThisUserName}"
then
  /bin/mkdir -p "/Users/${GLB_sv_ThisUserName}"
  /bin/chmod 750 "/Users/${GLB_sv_ThisUserName}"
  /usr/sbin/chown ${GLB_sv_ThisUserName}:wheel "/Users/${GLB_sv_ThisUserName}"
fi

# -- The following is executed as root --

/usr/local/LabWarden/lib/Trigger "Sys-ConsoleUserLoggedIn" "$(whoami)" "${GLB_sv_ThisUserName}"

# -- The following is executed as the user who is logging in --

# 'HEREDOC' is quoted to prevent variable expansion.
# This means that variables outside are not available.
 
/usr/bin/su ${GLB_sv_ThisUserName} <<'HEREDOC'

/usr/local/LabWarden/lib/Trigger "Usr-ConsoleUserLoggedIn"

HEREDOC

# -- We are back as the root user.
